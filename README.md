# scheduler-refactor

## 项目概述

这是一个基于Go语言开发的分布式任务调度系统，提供了可靠的定时任务执行、监控和管理功能。系统由Master节点和Worker节点组成，采用分布式架构设计。

## 核心特性

- **分布式架构**：支持多个Worker节点，实现任务的分布式执行
- **高可用设计**：基于etcd实现分布式协调和服务发现
- **实时任务调度**：支持cron表达式定义任务执行周期
- **任务管理**：支持任务的创建、修改、删除、启用和禁用
- **任务监控**：记录并展示任务执行日志和状态
- **分布式锁**：防止任务重复执行，确保高并发环境下的任务唯一性
- **节点健康监控**：监控Worker节点状态，自动处理节点故障
- **Web管理界面**：提供友好的任务管理和监控界面

## 系统架构

### 后端架构

```plaintext
+----------------------------------------------+
|              分布式任务调度系统               |
+----------------------------------------------+

+-----------------+       +------------------+
|    前端应用      |<----->|     后端服务      |
| (Vue.js + Vuex) |  HTTP |   (Gin + Zap)    |
+-----------------+       +------------------+
                                 |
                 +---------------+---------------+
                 |               |               |
        +----------------+ +------------+ +-------------+
        |   任务管理模块   | | 日志管理模块 | | 节点管理模块  |
        +----------------+ +------------+ +-------------+
                 |               |               |
                 |               |               |
                 v               v               v
           +-----------+    +-----------+    +-----------+
           |   etcd    |    | MongoDB   |    |  Worker   |
           | 任务存储    |    | 日志存储   |    |  注册中心   |
           +-----------+    +-----------+    +-----------+
                                                  |
                                                  v
                  +------------------------------------------+
                  |               Worker 节点群               |
                  +------------------------------------------+
                  |                                          |
    +-----------------+  +-----------------+  +-----------------+
    |    Worker #1    |  |    Worker #2    |  |    Worker #N    |
    +-----------------+  +-----------------+  +-----------------+
    | 注册器 | 调度器   |  | 注册器 | 调度器   |  | 注册器 | 调度器   |
    +-----------------+  +-----------------+  +-----------------+
    | 执行器 | 分布式锁 |  | 执行器 | 分布式锁 |  | 执行器 | 分布式锁 |
    +-----------------+  +-----------------+  +-----------------+
    |    日志收集器     |  |    日志收集器     |  |    日志收集器     |
    +-----------------+  +-----------------+  +-----------------+

+----------------------------------------------+
|               数据流向                        |
+----------------------------------------------+
1. Master存储任务配置到etcd
2. Worker通过etcd监听任务变更
3. Worker使用分布式锁争抢任务执行权
4. Worker执行任务并收集结果
5. 执行结果写入MongoDB
6. Master从MongoDB查询任务日志
7. 前端通过HTTP API获取数据并展示
```

#### 组件说明

1. **Master节点**：
   - **API服务器**：提供RESTful API接口，处理任务管理请求
   - **任务管理器**：负责任务的CRUD操作
   - **日志管理器**：处理任务执行日志的存储和查询
   - **Worker管理器**：监控Worker节点的健康状态

2. **Worker节点**：
   - **调度器**：根据cron表达式调度任务执行
   - **执行器**：实际执行任务并收集结果
   - **日志收集器**：收集任务执行日志
   - **注册器**：向Master注册Worker节点并定时发送心跳

3. **存储组件**：
   - **etcd**：存储任务配置，提供分布式锁服务
   - **MongoDB**：存储任务执行日志

### 前端架构

前端使用Vue.js开发，提供了直观的Web管理界面，包括：
- 任务管理面板
- 任务执行日志查看
- Worker节点状态监控
- 系统统计信息展示

## 技术栈

### 后端

- **Go**：核心开发语言
- **etcd**：分布式键值存储，用于服务发现和分布式锁
- **MongoDB**：存储任务执行日志
- **Gin**：Web框架，提供RESTful API
- **Zap**：高性能日志库
- **cron**：任务调度库，解析和执行cron表达式
- **context**：用于管理goroutine的生命周期和超时控制

### 前端

- **Vue 3**：前端开发框架
- **Bootstrap 5**：UI组件库
- **Axios**：HTTP客户端
- **Vue Router**：前端路由管理
- **Vuex**：状态管理

## 代码结构

```
scheduler-refactor/
├── common/        # 共享定义、常量和工具
├── config/        # 配置管理
├── frontend/      # Vue前端应用
├── master/        # Master节点组件
│   ├── api/       # RESTful API处理
│   ├── jobmgr/    # 任务管理
│   ├── logmgr/    # 日志管理
│   └── workermgr/ # Worker节点管理
├── pkg/           # 共享包
│   ├── etcd/      # etcd客户端封装
│   └── mongodb/   # MongoDB客户端封装
└── worker/        # Worker节点组件
    ├── executor/  # 任务执行器
    ├── joblock/   # 分布式锁实现
    ├── jobmgr/    # 任务管理客户端
    ├── logsink/   # 日志收集器
    ├── register/  # Worker注册模块
    └── scheduler/ # 任务调度器
```

## 核心流程

### 任务调度执行流程

1. **任务创建**：通过Master API创建任务，保存到etcd中
2. **任务调度**：Worker节点监听etcd中的任务变化，将任务加载到本地调度计划中
3. **执行准备**：调度器根据cron表达式计算下一次执行时间
4. **抢占锁**：任务执行前，Worker通过etcd获取分布式锁，确保同一时间只有一个Worker执行任务
5. **任务执行**：获得锁的Worker执行命令，收集输出和退出码
6. **释放锁**：执行完成后释放锁，允许其他Worker在下次调度时获取锁
7. **日志收集**：将执行结果保存到MongoDB
8. **结果反馈**：通过API接口查询任务状态和日志

### Worker注册流程

1. **启动注册**：Worker启动时向etcd注册自身信息
2. **心跳维持**：定期发送心跳，更新节点状态
3. **节点监控**：Master监控所有Worker节点的心跳状态
4. **故障检测**：超过心跳超时阈值的节点被标记为离线

## 部署要求

### 系统要求

- Go 1.16+
- etcd 3.4+
- MongoDB 4.0+
- Node.js 14+ (前端开发)

### 后端部署

1. 安装依赖
```bash
go mod download
```

2. 编译Master和Worker
```bash
go build -o master ./cmd/master
go build -o worker ./cmd/worker
```

3. 配置文件设置

使用`.json`文件进行配置，可以直接修改根目录下的`worker.json`和`master.json`：

```json
{
  "etcdEndpoints": ["localhost:2379"],
  "etcdDialTimeout": 5000,
  "workerId": "worker1",
  "heartbeatInterval": 3000,
  "logBatchSize": 50,
  "logCommitTimeout": 2000,
  "executorThreads": 5,
  "jobLockTtl": 10,
  "mongoUri": "mongodb://localhost:27017",
  "mongoConnectTimeout": 3000
}
```

4. 启动服务
```bash
./master -config -config .\master.json # json文件路径
./worker -config -config .\worker.json
```

### 前端部署

1. 安装依赖
```bash
cd frontend
npm install
```

2. 开发模式
```bash
npm run serve
```

3. 构建生产版本
```bash
npm run build
```

## API接口文档

### 任务管理

- `POST /api/v1/job/save` - 保存任务
- `DELETE /api/v1/job/:name` - 删除任务
- `GET /api/v1/job/list` - 获取任务列表
- `GET /api/v1/job/:name` - 获取任务详情
- `POST /api/v1/job/kill/:name` - 强制终止任务
- `POST /api/v1/job/disable/:name` - 禁用任务
- `POST /api/v1/job/enable/:name` - 启用任务

### 日志管理

- `GET /api/v1/log/list` - 获取任务日志列表
- `GET /api/v1/log/:name` - 获取任务最新日志
- `GET /api/v1/log/stats/:name` - 获取任务日志统计

### Worker管理

- `GET /api/v1/worker/list` - 获取工作节点列表
- `GET /api/v1/worker/stats` - 获取工作节点统计信息

## 许可证

本项目采用MIT许可证，详情请参阅LICENSE文件。
